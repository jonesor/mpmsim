<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mpmsim">
<title>The robustness of age from stage methods • mpmsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The robustness of age from stage methods">
<meta property="og:description" content="mpmsim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mpmsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/age_from_stage.html">The robustness of age from stage methods</a>
    <a class="dropdown-item" href="../articles/error_propagation.html">Sampling error and its propagation</a>
    <a class="dropdown-item" href="../articles/pca.html">Exploring PCA space</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jonesor/mpmsim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>The robustness of age from stage methods</h1>
                        <h4 data-toc-skip class="author">Owen Jones</h4>
            
            <h4 data-toc-skip class="date">2024-06-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jonesor/mpmsim/blob/HEAD/vignettes/age_from_stage.Rmd" class="external-link"><code>vignettes/age_from_stage.Rmd</code></a></small>
      <div class="d-none name"><code>age_from_stage.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Stage-classified matrix population models (Lefkovitch models), are
valuable tools for studying population dynamics, especially in cases
where organism demography is dependent on ontogenetic stage and
populations where age determination is difficult. While analysis of
these models is often adequate, there are situations where age-related
information is desired, such as with a Leslie matrix or life table.
Cochran and Ellner (1992) developed methods to obtain age-related life
history traits by breaking down the transition matrix into birth,
survival, and fission matrices. These methods allow for the calculation
of the discrete survivorship and maternity functions. From these two
fundamental trajectories, various life history metrics can be calculated
including mean age at maturity, generation time, age-specific
reproductive value, and senescence measures.</p>
<p>But how well do these methods really perform? For example, do they
perform equally well for all functional forms of mortality? Can they
capture differences in senescence rate?</p>
<p>The following vignette illustrates how <code>mpmsim</code> can be
used to address one of these questions.</p>
</div>
<div class="section level2">
<h2 id="age-from-stage">Age-from-stage<a class="anchor" aria-label="anchor" href="#age-from-stage"></a>
</h2>
<p>First we load the required packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonesor/mpmsim" class="external-link">mpmsim</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonesor/Rage" class="external-link">Rage</a></span><span class="op">)</span></span></code></pre></div>
<p>Next we will use the <code><a href="../reference/model_survival.html">model_survival()</a></code> function create a
<code>list</code> of age-specific survival trajectories based on a
Gompertz mortality function with senescence rates
(<code>b_1_values</code>) varying between 0.1 and 0.9. These values are
the basis for our life tables.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b_1_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">lifeTables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">b_1_values</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_survival.html">model_survival</a></span><span class="op">(</span></span>
<span>    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>b_0 <span class="op">=</span> <span class="fl">0.1</span>, b_1 <span class="op">=</span> <span class="va">b_1_values</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    model <span class="op">=</span> <span class="st">"Gompertz"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For this analysis we want to convert these age-based trajectories
into stage-based matrix models. To do that we will divide the yearly age
entries into stages. We do this in an arbitrary way by dividing the age
vector into 3 parts: a quarter for juveniles, a half for adult, and
another quarter for old individuals.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>stage <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>      <span class="va">x</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next we’ll add fertility to those life tables.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>fert <span class="op">=</span> <span class="fu"><a href="../reference/model_fertility.html">model_fertility</a></span><span class="op">(</span></span>
<span>      age <span class="op">=</span> <span class="va">x</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>      maturity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">stage</span> <span class="op">==</span> <span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      model <span class="op">=</span> <span class="st">"step"</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s take a look at one of these life tables so that the data
preparation so far is clear. The most important columns here are age
(<code>x</code>), survival (<code>px</code>), fertility
(<code>fert</code>) and <code>stage</code> (see
<code><a href="https://rdrr.io/pkg/Rage/man/mpm_to_table.html" class="external-link">?mpm_to_table</a></code> for an explanation of the columns in the life
table).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lifeTables</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt;   x        hx         lx        qx         px stage fert</span></span>
<span><span class="co">#&gt; 1 0 0.1000000 1.00000000 0.1240411 0.87595894     1    0</span></span>
<span><span class="co">#&gt; 2 1 0.1648721 0.87595894 0.1961561 0.80384392     1    0</span></span>
<span><span class="co">#&gt; 3 2 0.2718282 0.70413427 0.3023227 0.69767734     1    0</span></span>
<span><span class="co">#&gt; 4 3 0.4481689 0.49125852 0.4476301 0.55236995     2    3</span></span>
<span><span class="co">#&gt; 5 4 0.7389056 0.27135645 0.6241546 0.37584536     2    3</span></span>
<span><span class="co">#&gt; 6 5 1.2182494 0.10198806 0.8007912 0.19920884     3    3</span></span>
<span><span class="co">#&gt; 7 6 2.0085537 0.02031692 0.9300552 0.06994476     3    3</span></span></code></pre></div>
<p>The next step is to turn these life tables into matching pairs of (1)
Leslie matrices and (2) stage-based matrices.</p>
<div class="section level3">
<h3 id="leslie-matrices">Leslie matrices<a class="anchor" aria-label="anchor" href="#leslie-matrices"></a>
</h3>
<p>First Now we can turn these life tables containing age-specific
survival and fertility trajectories into Leslie matrices using the
<code>make_leslie_mpm</code> function. These matrix models can be large
or small depending on the maximum life span of the population: the life
tables are, by default, constrained to extend to the age where the
survivorship function falls below 0.01.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">leslie_matrices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">leslie_matrices</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_leslie_mpm.html">make_leslie_mpm</a></span><span class="op">(</span></span>
<span>    survival <span class="op">=</span> <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">px</span>,</span>
<span>    fertility <span class="op">=</span> <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">fert</span>,</span>
<span>    n_stages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, split <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s examine the Leslie matrix that matches the life table from the
previous section.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">leslie_matrices</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mat_A</span></span>
<span><span class="co">#&gt;           [,1]      [,2]      [,3]      [,4]      [,5]      [,6]       [,7]</span></span>
<span><span class="co">#&gt; [1,] 0.0000000 0.0000000 0.0000000 3.0000000 3.0000000 3.0000000 3.00000000</span></span>
<span><span class="co">#&gt; [2,] 0.8759589 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 0.00000000</span></span>
<span><span class="co">#&gt; [3,] 0.0000000 0.8038439 0.0000000 0.0000000 0.0000000 0.0000000 0.00000000</span></span>
<span><span class="co">#&gt; [4,] 0.0000000 0.0000000 0.6976773 0.0000000 0.0000000 0.0000000 0.00000000</span></span>
<span><span class="co">#&gt; [5,] 0.0000000 0.0000000 0.0000000 0.5523699 0.0000000 0.0000000 0.00000000</span></span>
<span><span class="co">#&gt; [6,] 0.0000000 0.0000000 0.0000000 0.0000000 0.3758454 0.0000000 0.00000000</span></span>
<span><span class="co">#&gt; [7,] 0.0000000 0.0000000 0.0000000 0.0000000 0.0000000 0.1992088 0.06994476</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="lefkovitch-matrices">Lefkovitch matrices<a class="anchor" aria-label="anchor" href="#lefkovitch-matrices"></a>
</h3>
<p>From these Leslie matrices we can now construct the stage-structured
matrix models (Lefkovitch models) using the <code><a href="https://rdrr.io/pkg/Rage/man/mpm_collapse.html" class="external-link">mpm_collapse()</a></code>
function from <code>Rage</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">collapsed_matrices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">stages</span> <span class="op">&lt;-</span> <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">stage</span></span>
<span>  <span class="va">matrices</span> <span class="op">&lt;-</span> <span class="va">leslie_matrices</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">collapse_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">stages</span>, <span class="va">stages</span><span class="op">)</span></span>
<span>  <span class="co"># get the indices of each element in the original vector</span></span>
<span>  <span class="va">collapse_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">collapse_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">stages</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">collapsed_matrices</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">Rage</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rage/man/mpm_collapse.html" class="external-link">mpm_collapse</a></span><span class="op">(</span></span>
<span>    matU <span class="op">=</span> <span class="va">matrices</span><span class="op">$</span><span class="va">mat_U</span>,</span>
<span>    matF <span class="op">=</span> <span class="va">matrices</span><span class="op">$</span><span class="va">mat_F</span>, collapse <span class="op">=</span> <span class="va">collapse_list</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s examine the Lefkovitch matrix that matches the Leslie matrix
and life table from the previous sections:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">collapsed_matrices</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">matA</span></span>
<span><span class="co">#&gt;           1         2        3</span></span>
<span><span class="co">#&gt; 1 0.6670591 3.0000000 3.000000</span></span>
<span><span class="co">#&gt; 2 0.1476356 0.3821296 0.000000</span></span>
<span><span class="co">#&gt; 3 0.0000000 0.1158355 0.180401</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="recovering-age-specific-trajectories-from-the-stage-based-model">Recovering age-specific trajectories from the stage-based model<a class="anchor" aria-label="anchor" href="#recovering-age-specific-trajectories-from-the-stage-based-model"></a>
</h2>
<p>Next we can use age-from stage-approximation to see how well we can
recover the “true” values in the original Leslie matrix/life table. In
the plot, the red curve represents the “true” values of survivorship
from the life table and the black curve represents the estimation of
survivorship using age-from-stage approximation.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recovered_life_tables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">m1</span> <span class="op">&lt;-</span> <span class="va">collapsed_matrices</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">recovered_life_tables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">Rage</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rage/man/mpm_to_table.html" class="external-link">mpm_to_table</a></span><span class="op">(</span></span>
<span>    matU <span class="op">=</span> <span class="va">m1</span><span class="op">$</span><span class="va">matU</span>, matF <span class="op">=</span> <span class="va">m1</span><span class="op">$</span><span class="va">matF</span>,</span>
<span>    remove_final <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">recovered_lt</span> <span class="op">&lt;-</span> <span class="va">recovered_life_tables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/popdemo/man/Projection-plots.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">recovered_lt</span><span class="op">$</span><span class="va">lx</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="va">recovered_lt</span><span class="op">$</span><span class="va">lx</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"age"</span>, ylab <span class="op">=</span> <span class="st">"survivorship"</span>, main <span class="op">=</span> <span class="st">"Survivorship"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span>, <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">lx</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="age_from_stage_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="mortality-and-longevity">Mortality and longevity<a class="anchor" aria-label="anchor" href="#mortality-and-longevity"></a>
</h2>
<p>We could also look at other life table trajectories such as mortality
(hazard).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/popdemo/man/Projection-plots.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">recovered_lt</span><span class="op">$</span><span class="va">lx</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="va">recovered_lt</span><span class="op">$</span><span class="va">hx</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">"age"</span>, ylab <span class="op">=</span> <span class="st">"mortality"</span>, main <span class="op">=</span> <span class="st">"mortality"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span>, <span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">hx</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="age_from_stage_files/figure-html/unnamed-chunk-12-1.png" width="576" style="display: block; margin: auto;"></p>
<p>This plot clearly shows that mortality (hazard) is underestimated
across most of the life course and that the trajectory is markedly
different from the underlying Gompertz trajectory. This is caused by the
known issue of the population structure reaching its stationary state:
When the population reaches this state, the rate of change in the
mortality/survival trajectory will asymptote to zero.</p>
<p>We can now examine how the over-estimation of life span using
age-from-stage methods is related to the Gompertz parameter like
this.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">b_1_values</span>, lifespan_lt <span class="op">=</span> <span class="cn">NA</span>, lifespan_afs <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df1</span><span class="op">$</span><span class="va">lifespan_lt</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lifeTables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">df1</span><span class="op">$</span><span class="va">lifespan_afs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">recovered_life_tables</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">df1</span> <span class="op">&lt;-</span> <span class="va">df1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lifespan_diff <span class="op">=</span> <span class="va">lifespan_afs</span> <span class="op">-</span> <span class="va">lifespan_lt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lifespan_diff_perc <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">lifespan_diff</span> <span class="op">/</span> <span class="va">lifespan_lt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/popdemo/man/Projection-plots.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">df1</span><span class="op">$</span><span class="va">b_1_values</span>, <span class="va">df1</span><span class="op">$</span><span class="va">lifespan_diff_perc</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">"Lifespan overestimation (%)"</span>, xlab <span class="op">=</span> <span class="st">"Gompertz parameter"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="age_from_stage_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="further-questions">Further questions?<a class="anchor" aria-label="anchor" href="#further-questions"></a>
</h2>
<p>As explained elsewhere, this issue can be ameliorated by examining
the convergence to the quasi-stationary state (QSD) (see
<code>?Rage::qsd_converge()</code>) and it affects both
mortality/survival and fertility. One could use the methods outlined
here to explore these issues more thoroughly by (for example) checking
how age-from-stage methods perform with different life histories and
different functional forms of mortality (see
<code>?mpmsim::model_survival()</code>) and fertility.
(<code>?mpmsim::model_fertility()</code>).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Owen Jones.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
