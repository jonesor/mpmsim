---
title: "Exploring PCA space"
author: "Owen Jones"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exploring PCA space}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

```

1. Simulate 100 matrices with random life histories
2. calculate key life history parameters

Load the required packages
```{r}
library(mpmsim)
library(Rcompadre)
library(dplyr)
library(ggfortify)
library(viridis)

```

First use `generate_mpm_set()` to simulate 500 matrices with the archetype 1 life history from Takada et al. (2018). This life history archetype is one where transition from/to any stage is possible and where individuals can progress and retrogress rapidly. After simulating the matrices they can be placed into a `CompadreDB` object using `cdb_build_cdb()`.

```{r}
set.seed(42)
mpm_set <- generate_mpm_set(
  n = 500, lower_lambda = 0.9, upper_lambda = 1.1,
  n_stages = 3, fecundity = c(0, 6, 6), archetype = 1, split = TRUE
)

sim_life_hist_1 <- cdb_build_cdb(mat_u = mpm_set$U_list, mat_f = mpm_set$F_list)
```

Some of these matrices will be reducible, which leads to analytical problems with some calculations tHese can be filtered out using `cdb_flag()` followed by `filter()`

```{r}
sim_life_hist_1 <- cdb_flag(sim_life_hist_1, checks = "check_irreducible") %>%
  filter(check_irreducible == TRUE)
```

For convenience, these matrices can be added to the `compadreDB` object like this, and turned into a regular data frame (tibble) like this.

```{r}
# Put the matrices into the metadata
sim_life_hist_1$matA <- matA(sim_life_hist_1)
sim_life_hist_1$matU <- matU(sim_life_hist_1)
sim_life_hist_1$matF <- matF(sim_life_hist_1)

# Use cdb_metadata to turn this into a data frame
sim_life_hist_1 <- cdb_metadata(sim_life_hist_1)
head(sim_life_hist_1)
```
Before proceeding with the calculation of life history traits I make some new functions to calculate Demetrius' and Keyfitz entropy direct from MPM rather than from a lx/mx trajectory. THese will be added to `Rage` soon!

```{r}
# New functions to calculate Demetrius' and Keyfitz entropy direct from matrix
# I should add these to Rage (or add the functionality to existing functions)
entropy_d_mat <- function(matU, matF, start = 1) {
  lx <- mpm_to_lx(matU, start = start)
  mx <- mpm_to_mx(matU, matF, start = start)
  return(entropy_d(lx, mx))
}

entropy_k_mat <- function(matU, start = 1, ...) {
  lx <- mpm_to_lx(matU, start = start)
  return(entropy_k(lx, ...))
}

# Function to calculate generation time from the life table
gt_lt <- function(matU, matF, start = 1, ...) {
  tempLT <- mpm_to_table(matU, matF, start = start, ...)
  return(sum(tempLT$x * tempLT$lxmx) / sum(tempLT$lxmx))
}

Now we can use a combination of sapply and mapply to calcualte the life history traits for each matrix.

```{r}
sim_life_hist_1$gt <- sapply(sim_life_hist_1$matA, popbio::generation.time)
sim_life_hist_1$gt_lt <- mapply(gt_lt, sim_life_hist_1$matU, sim_life_hist_1$matF)
sim_life_hist_1$longevity <- sapply(sim_life_hist_1$matU, Rage::longevity, x_max = 1000, lx_crit = 0.01)
sim_life_hist_1$lifeExpect <- sapply(sim_life_hist_1$matU, Rage::life_expect_mean)
sim_life_hist_1$entropy_d <- mapply(entropy_d_mat, sim_life_hist_1$matU, sim_life_hist_1$matF)
sim_life_hist_1$entropy_k <- mapply(entropy_k_mat, sim_life_hist_1$matU)
sim_life_hist_1$nrr_R0 <- mapply(net_repro_rate, sim_life_hist_1$matU, sim_life_hist_1$matF)
sim_life_hist_1$gt_Rage <- mapply(gen_time, sim_life_hist_1$matU, sim_life_hist_1$matF)
sim_life_hist_1$reac <- sapply(sim_life_hist_1$matA, popdemo::reac, bound = "upper")
sim_life_hist_1$dr <- sapply(sim_life_hist_1$matA, popdemo::dr)

# Prepare data for PCA analysis
pcData <- sim_life_hist_1 %>%
  select(gt_lt, longevity, lifeExpect, entropy_d, entropy_k, nrr_R0, reac, dr) %>%
  na.omit()


PCA <- prcomp(pcData, scale = TRUE, center = TRUE)

# Add the PC data to the raw data.
pcData <- pcData %>%
  cbind(PCA$x[, 1:2])

PCA_plot <- autoplot(
  object = PCA, alpha = 0, size = 4, fill = "#55616D60", loadings.colour = "#0072B2", shape = 16,
  loadings = TRUE, loadings.label = TRUE, loadings.label.colour = "black",
  loadings.label.size = 3, loadings.label.repel = TRUE,
  frame = FALSE, frame.type = "norm", scale = 0
)

PCA_plot$layers <- c(geom_point(aes_(x = pcData$PC1, y = pcData$PC2), size = 2, alpha = .5), PCA_plot$layers)
PCA_plot
ggsave("PCA_life_hist_1.png", width = 10, height = 8)

# Lets repeat this with another archetype of life history
mpm_set <- generate_mpm_set(
  n = 500, lower_lambda = 0.9, upper_lambda = 1.1,
  n_stages = 3, fecundity = c(0, 6, 6), archetype = 4, split = TRUE
)

sim_life_hist_4 <- cdb_build_cdb(mat_u = mpm_set$U_list, mat_f = mpm_set$F_list)

# Identify irreducible matrices so they can be filtered out
sim_life_hist_4 <- cdb_flag(sim_life_hist_4, checks = "check_irreducible") %>%
  filter(check_irreducible == TRUE)

# Put the matrices into the metadata
sim_life_hist_4$matA <- matA(sim_life_hist_4)
sim_life_hist_4$matU <- matU(sim_life_hist_4)
sim_life_hist_4$matF <- matF(sim_life_hist_4)

# Use cdb_metadata to turn this into a data frame
sim_life_hist_4 <- cdb_metadata(sim_life_hist_4)
head(sim_life_hist_4)


# Use a combination of sapply and mapply to calcualte the life history traits for each matrix.
sim_life_hist_4$gt <- sapply(sim_life_hist_4$matA, popbio::generation.time)
sim_life_hist_4$gt_lt <- mapply(gt_lt, sim_life_hist_4$matU, sim_life_hist_4$matF)
sim_life_hist_4$longevity <- sapply(sim_life_hist_4$matU, Rage::longevity, x_max = 1000, lx_crit = 0.01)
sim_life_hist_4$lifeExpect <- sapply(sim_life_hist_4$matU, Rage::life_expect_mean)
sim_life_hist_4$entropy_d <- mapply(entropy_d_mat, sim_life_hist_4$matU, sim_life_hist_4$matF)
sim_life_hist_4$entropy_k <- mapply(entropy_k_mat, sim_life_hist_4$matU)
sim_life_hist_4$nrr_R0 <- mapply(net_repro_rate, sim_life_hist_4$matU, sim_life_hist_4$matF)
sim_life_hist_4$gt_Rage <- mapply(gen_time, sim_life_hist_4$matU, sim_life_hist_4$matF)
sim_life_hist_4$reac <- sapply(sim_life_hist_4$matA, popdemo::reac, bound = "upper")
sim_life_hist_4$dr <- sapply(sim_life_hist_4$matA, popdemo::dr)

# Prepare data for PCA analysis
pcData <- sim_life_hist_4 %>%
  select(gt_lt, longevity, lifeExpect, entropy_d, entropy_k, nrr_R0, reac, dr) %>%
  na.omit()

PCA <- prcomp(pcData, scale = TRUE, center = TRUE)

# Add the PC data to the raw data.
pcData <- pcData %>%
  cbind(PCA$x[, 1:2])

PCA_plot <- autoplot(
  object = PCA, alpha = 0, size = 4, fill = "#55616D60", loadings.colour = "#0072B2", shape = 16,
  loadings = TRUE, loadings.label = TRUE, loadings.label.colour = "black",
  loadings.label.size = 3, loadings.label.repel = TRUE,
  frame = FALSE, frame.type = "norm", scale = 0
)

PCA_plot$layers <- c(geom_point(aes_(x = pcData$PC1, y = pcData$PC2), size = 2, alpha = .5), PCA_plot$layers)
PCA_plot
ggsave("PCA_life_hist_4.png", width = 10, height = 8)


```

