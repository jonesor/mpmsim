---
title: "Generate a set of Leslie matrices"
author: "Owen Jones"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate a set of Leslie matrices}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(42)
```

## Introduction

Leslie matrix models, named after Patrick Leslie, are a type of matrix population model used to describe demography of age structured populations. They are commonly used in studies of wildlife,conservation and evolutionary biology.

In a Leslie matrix the square matrix is used to model discrete, age-structured population growth with a projection interval (time step) typically representing years. Each element in the matrix represents a transition probability between different age classes or the fertility of the age class. The information in matrix model can be split into two submatrices, representing survival/growth and reproduction (the fertility vector) respectively.

* **Survival Probabilities**: The subdiagonal (immediately below the main diagonal) of the Leslie matrix consists of survival probabilities. Each entry here shows the probability that an individual of one age class will survive to the next age class. These probabilities can be understood as an age trajectory of survival, that can be modelled using a mathematical model describing how age-specific mortality changes with age.

* **Fertility**: The first row of the Leslie matrix contains the reproductive rates of each age class. These entries indicate how many new individuals each age class can expect to produce in each projection interval.

All other entries in the matrix are typically zero, indicating that those transitions are impossible.

To project the population size an structure through time, the Leslie matrix is multiplied by a vector that represents the current population structure (number of individuals in each age class). The result is a new vector showing the predicted structure of the population in the next time step. This process can be repeated to model population changes over multiple time periods.

Leslie matrices are useful for studying population dynamics under different scenarios, such as changes in survival rates, fecundity rates, or management strategies, and they have been widely applied in both theoretical and applied ecology.

## Aims

The purpose of this vignette is to illustrate how to simulate sets of Leslie MPMs based on known functional forms of mortality and fertility. There are several reasons why one would want to do this, including, but not limited to:

*Exploring how senescence parameters influence dynamics.
*To obtain MPMs based on parameter estimates of mortality and fertility obtained using other methods.
*To produce MPMs with known properties for teaching purposes.

In the next sections this document will:

1) Explain the basics of mortality and fertility trajectories.
2) Show how to obtain trajectories of mortality and fertility.
3) Show how to use those trajectories to produce life tables and matrix population models.
4) Show how to generate sets of many MPMs based on defined mortality and fertility characteristics.

## Preparation

Before starting, we load the required packages.

```{r, message=FALSE}
library(mpmsim)
library(dplyr)
library(Rage)
library(ggplot2)
```

## Functional forms of mortality and fertility

There are numerous published and well-used functional forms used to describe how mortality risk (hazard) changes with age. The `model_mortality`  function (and its synonym `model_survival`) handles 6 of these models: Gompertz, Gompertz-Makeham, Weibull, Weibull-Makeham, Siler and Exponential. 

In a nutshell:

* Gompertz: A mortality rate that increases exponentially with age.
* Gompertz-Makeham: A mortality rate that increases exponentially with age, with an additional age-independent constant mortality.
* Weibull: A mortality rate that scales with age, increasing at a rate that can either accelerate or decelerate, depending on the parameters of the model.
* Weibull-Makeham: as the basic Weibull, but with an additional age-independent constant mortality
* Siler: A mortality model that separates mortality rates into two age-related components â€” juvenila mortality, which declines exponentially with age and adult mortality, which increases exponentially.
* Exponential: Constant mortality that is unchanging with age.

These are illustrated below, see `?model_mortality` for the equations.

```{r echo = FALSE, message=FALSE, fig.height=4, fig.width =8}
library(patchwork)
A <- model_mortality(
  params = c(b_0 = 0.01, b_1 = 0.5),
  model = "Gompertz"
)

plotA <- ggplot(A,aes(x = x, y = hx)) + 
  geom_line() + 
  xlab("Age") + 
  ylab("Hazard") + 
  ggtitle("A) Gompertz") 


B <- model_mortality(
  params = c(b_0 = 0.01, b_1 = 0.5, C = 0.2),
  model = "GompertzMakeham"
)

plotB <- ggplot(B,aes(x = x, y = hx)) + 
  geom_line() + 
  xlab("Age") + 
  ylab("Hazard") + 
  ggtitle("B) Gompertz-Makeham") + 
  geom_hline(yintercept = 0.2,linetype =2 ) + 
  coord_cartesian(ylim = c(0, NA))


C <- model_mortality(
  params = c(a_0 = 0.15, a_1 = 0.3, C = -0.11, b_0 = 0.1, b_1 = 0.1),
  model = "Siler"
)

plotC <- ggplot(C,aes(x = x, y = hx)) + 
  geom_line() + 
  xlab("Age") + 
  ylab("Hazard") + 
  ggtitle("C) Siler") + 
  coord_cartesian(ylim = c(0, NA))

D <- model_mortality(
  params = c(b_0 = 1.51, b_1 = 0.15),
  model = "Weibull"
)

plotD <- ggplot(D,aes(x = x, y = hx)) + 
  geom_line() + 
  xlab("Age") + 
  ylab("Hazard") + 
  ggtitle("D) Weibull") 

E <- model_mortality(
    params = c(b_0 = 1.51, b_1 = 0.15, C = 0.05),
  model = "WeibullMakeham"
)

plotE <- ggplot(E,aes(x = x, y = hx)) + 
  geom_line() + 
  xlab("Age") + 
  ylab("Hazard") + 
  ggtitle("F) Weibull-Makeham") + 
  geom_hline(yintercept = 0.05,linetype =2 ) + 
  coord_cartesian(ylim = c(0, NA))

FF <- model_mortality(
  params = c(b_0 = 0.1),
  model = "Exponential"
)

plotFF <- ggplot(FF,aes(x = x, y = hx)) + 
  geom_line() + 
  xlab("Age") + 
  ylab("Hazard") + 
  ggtitle("E) Exponential") 


plotA + plotB + plotC + plotD + plotE + plotFF

```

In addition to these functional forms of mortality, there are of course functional forms that have been used to model fertility. The `model_fertility` function handles five types: logistic, step, von Bertalanffy, Normal and Hadwiger.


* Logistic: Fertility initially increases rapidly with age then slows to plateau as it approaches a maximum value.
* Step: Fertility is initially zero, then jumps to a particular level at a specified age, after which it remains constant.
* von Bertalanffy: This model is often used in growth dynamics but has been adapted for fertility to describe changes over age or time following a logistic growth form not limited by a strict upper asymptote. It shows how fertility rates might increase and then decrease, following a more smoothed, sigmoid curve.
* Normal : Fertility is modelled as normal distribution to describe how fertility rates increase, peak, and then decreases in a bell curve around a mean age of reproductive capacity.
* Hadwiger: The outcomes of this model is qualitatively similar to the normal distribution.

Collectively, these mortality and fertility functions offer a large scope for modelling the variety of demographic trajectories apparent across the tree of life.

## Obtain trajectories of mortality and fertility

To obtain a trajectory of mortality we can use the `model_mortality()` function which takes as input the parameters of a specified mortlaity model. The output of this function is a standard life table `data.frame` including columns for age (`x`), age-specific hazard (`hx`), survivorship (`lx`), age-specific probability of death and survival (`qx` and `px`). By default, the life table is truncated at the age when the survivorship function declines below 0.01 (i.e. when only 1% of individuals in a cohort would remain alive).

```{r}
(lt1 <- model_mortality(params = c(b_0 = 0.1, b_1 = 0.2), model = "Gompertz"))
```

It can be useful to explore the impact of parameters on the mortality hazard (`hx`) graphically, especially for users that are unfamiliar with the models chosen.

```{r echo = FALSE, message=FALSE, fig.height=4, fig.width =8}
ggplot(lt1,aes(x = x, y = hx)) + 
  geom_line() + 
  ggtitle("Gompertz mortality (b_0 = 0.1, b_1 = 0.2)")
```


The `model_fertility` function is similar to the `model_mortality` function, in that it has arguments for the type of fertility model, and its parameters. However, the output of the `model_fertility` function is a vector of fertility values rather than a `data.frame`. This allows us to add a fertility column (`fert`) directly to the life table produced earlier, as follows:


```{r}
  (lt1 <- lt1 |>
    mutate(fert = model_fertility(
      age = x, params = c(A = 3),
      maturity = 3,
      model = "step"
    )))
```

Again, it can be useful to plot the relevant data to visualise it.

```{r}
ggplot(lt1,aes(x = x, y = fert)) + 
  geom_line() + 
  ggtitle("Step fertility, maturity at age 3")
```



The next step is to turn these life tables into matching pairs of (1) Leslie matrices and (2) stage-based matrices.

### From life table to MPM

Now we can turn these life tables containing age-specific survival and fertility trajectories into Leslie matrices using the `make_leslie_mpm` function. These MPMs can be large or small depending on the maximum life span of the population. 
