---
title: "The robustness of age from stage methods"
author: "Owen Jones"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The robustness of age from stage methods}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

1) Lets simulate 5 matrices from a gompertz distribution with Gompertz parameters varying between 0.01 and 0.5
2) Lets convert those to stage-based matrices with 3 stages (e.g. juv, ad, senes)
3) Now lets use age-from-stage methods to calculate an age trajectory from these stage-based matrices.
4) How well do these new computed age-trajectories match with the "true" trajectories?
5) Is the ranking correct?
6) If we estimate the gomperz parameter, do we get close?

```{r}
library(mpmsim)
library(dplyr)
library(Rage)
```


```{r}
b_1_values <- seq(0.1, 0.9, 0.1)
lifeTables <- list()
for (i in 1:length(b_1_values)) {
  lifeTables[[i]] <- model_survival(
    params = c(b_0 = 0.1, b_1 = b_1_values[i]),
    model = "Gompertz"
  )
}
```



Next we'll slice those life tables to turn the yearly entries into stages. We do this in an arbitrary way by dividing the vector of age into 3 parts: a quarter for juveniles, a half for adult and another quarter for old individuals.

```{r}
for (i in 1:length(lifeTables)) {
  lifeTables[[i]] <- lifeTables[[i]] |>
    mutate(stage = ifelse(x <= round(max(x) * 0.25), 1,
      ifelse(x <= round(max(x) * 0.75), 2, 3)
    ))
}
```


Next we'll add fertility to those life tables.

```{r}
for (i in 1:length(lifeTables)) {
  lifeTables[[i]] <- lifeTables[[i]] |>
    mutate(fert = model_fertility(
      age = x, params = c(A = 3),
      maturity = min(x[stage == 2]),
      model = "step"
    ))
}
```


Now we can turn these life tables into Leslie matrices:

```{r}
leslie_matrices <- list()
for (i in 1:length(lifeTables)) {
  leslie_matrices[[i]] <- make_leslie_matrix(
    survival = lifeTables[[i]]$gx,
    fertility = lifeTables[[i]]$fert,
    n_stages = nrow(lifeTables[[i]]), split = TRUE
  )
}
```

From these information we build the stage-structured matrix models using `mpm_collapse()` from `Rage`

```{r}
collapsed_matrices <- list()
for (i in 1:length(lifeTables)) {
  stages <- lifeTables[[i]]$stage
  matrices <- leslie_matrices[[i]]
  collapse_list <- split(stages, stages)
  # get the indices of each element in the original vector
  collapse_list <- lapply(collapse_list, function(x) which(stages %in% x))

  collapsed_matrices[[i]] <- Rage::mpm_collapse(
    matU = matrices$mat_U,
    matF = matrices$mat_F, collapse = collapse_list
  )
}
```
Next we can use age-from stage-approximation to recover the original Leslie matrix.

```{r}
i <- 2
m1 <- collapsed_matrices[[i]]
recoveredLeslie <- Rage::mpm_to_table(matU = m1$matU, matF = m1$matF)

plot(0:(length(recoveredLeslie$lx) - 1), recoveredLeslie$lx, type = "l", xlab = "age", ylab = "survivorship")
lines(lifeTables[[i]]$x, lifeTables[[i]]$Sx, type = "l", col = "red")
```
